{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-5">
  <h2 class="text-center mb-4">Choose Your Items</h2>

  

  <!-- Filter Buttons -->
  <div class="text-center mb-4">
    {% for category in categories %}
      <button class="btn btn-outline-primary mx-1 filter-btn" data-category="{{ category }}">{{ category }}</button>
    {% endfor %}
  </div>

  <!-- Cart Summary -->
  <div class="mb-4">
  <h5>Your Cart</h5>
  {% if cart_items %}
    <ul class="list-group">
      {% for item in cart_items %}
        <li class="list-group-item d-flex justify-content-between align-items-center">
          <div>
            {{ item.product.name }} (x{{ item.quantity }})
          </div>
          <form action="{% url 'products:remove_from_cart' item.id %}" method="post" style="margin: 0;">
            {% csrf_token %}
            <button type="submit" class="btn btn-sm btn-outline-danger">Remove</button>
          </form>
        </li>
      {% endfor %}
    </ul>
    <p class="mt-3"><strong>Subtotal: â‚¹{{ cart_total }}</strong></p>
  {% else %}
    <p>No items in cart.</p>
  {% endif %}
  <form method="get" id="next-step-form">
      <input type="hidden" name="category" id="next-category" value="">
      <button type="submit" class="btn btn-success mt-2">Next Step</button>
    
  </form>
</div>
<!-- Toast Container -->
<div id="category-toast" class="toast align-items-center text-white bg-danger border-0 position-fixed top-0 end-0 m-4" role="alert" aria-live="assertive" aria-atomic="true" style="z-index: 9999;">
  <div class="d-flex">
    <div class="toast-body" id="toast-message">
      You can only add one item from this category.
    </div>
    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
  </div>
</div>


    <!-- Product Filters & Items -->
      <div id="products" class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-3 g-4">
        {% csrf_token %}

        <!-- Water Bottles -->
        <div class="col-md-3 mb-4 product-card" data-category="Bottles">
          <div class="card h-100">
            <img src="/media/products/Bottle1.jpeg" class="card-img-top" alt="Black sipper bottle">
            <div class="card-body text-center">
              <h5 class="card-title">Black sipper bottle</h5>
              <form method="post" action="{% url 'products:add_to_cart' 1 %}">
                {% csrf_token %}
                <input type="hidden" name="quantity" value="1">
                <button type="submit" class="btn btn-dark">Add to Cart</button>
              </form>
            </div>
          </div>
        </div>

        <div class="col-md-3 mb-4 product-card" data-category="Bottles">
          <div class="card h-100">
            <img src="/media/products/Bottle2.jpeg" class="card-img-top" alt="Green bottle">
            <div class="card-body text-center">
              <h5 class="card-title">Green bottle</h5>
              <form method="post" action="{% url 'products:add_to_cart' 2 %}">
                {% csrf_token %}
                <input type="hidden" name="quantity" value="1">
                <button type="submit" class="btn btn-dark">Add to Cart</button>
              </form>
            </div>
          </div>
        </div>

        <div class="col-md-3 mb-4 product-card" data-category="Bottles">
          <div class="card h-100">
            <img src="/media/products/Bottle3.jpeg" class="card-img-top" alt="Borosil bottle">
            <div class="card-body text-center">
              <h5 class="card-title">Borosil bottle</h5>
              <form method="post" action="{% url 'products:add_to_cart' 3 %}">
                {% csrf_token %}
                <input type="hidden" name="quantity" value="1">
                <button type="submit" class="btn btn-dark">Add to Cart</button>
              </form>
            </div>
          </div>
        </div>

        <div class="col-md-3 mb-4 product-card" data-category="Bottles">
          <div class="card h-100">
            <img src="/media/products/Bottle4.jpeg" class="card-img-top" alt="Bamboo lid and Jute cover bottle">
            <div class="card-body text-center">
              <h5 class="card-title">Bamboo lid and Jute cover bottle</h5>
              <form method="post" action="{% url 'products:add_to_cart' 4 %}">
                {% csrf_token %}
                <input type="hidden" name="quantity" value="1">
                <button type="submit" class="btn btn-dark">Add to Cart</button>
              </form>
            </div>
          </div>
        </div>

        <div class="col-md-3 mb-4 product-card" data-category="Bottles">
          <div class="card h-100">
            <img src="/media/products/Bottle5.jpeg" class="card-img-top" alt="Black premium sipper">
            <div class="card-body text-center">
              <h5 class="card-title">Black premium sipper</h5>
              <form method="post" action="{% url 'products:add_to_cart' 5 %}">
                {% csrf_token %}
                <input type="hidden" name="quantity" value="1">
                <button type="submit" class="btn btn-dark">Add to Cart</button>
              </form>
            </div>
          </div>
        </div>

        <!-- Notebooks -->
        <div class="col-md-3 mb-4 product-card" data-category="Notebooks">
          <div class="card h-100">
            <img src="/media/products/Notebook1.jpeg" class="card-img-top" alt="Minimalist Notebook">
            <div class="card-body text-center">
              <h5 class="card-title">Minimalist Notebook</h5>
              <form method="post" action="{% url 'products:add_to_cart' 6 %}">
                {% csrf_token %}
                <input type="hidden" name="quantity" value="1">
                <button type="submit" class="btn btn-dark">Add to Cart</button>
              </form>
            </div>
          </div>
        </div>

        <div class="col-md-3 mb-4 product-card" data-category="Notebooks">
          <div class="card h-100">
            <img src="/media/products/Notebook2.jpeg" class="card-img-top" alt="Urban Linen Notebook">
            <div class="card-body text-center">
              <h5 class="card-title">Urban Linen Notebook</h5>
              <form method="post" action="{% url 'products:add_to_cart' 12 %}">
                {% csrf_token %}
                <input type="hidden" name="quantity" value="1">
                <button type="submit" class="btn btn-dark">Add to Cart</button>
              </form>
            </div>
          </div>
        </div>

        <div class="col-md-3 mb-4 product-card" data-category="Notebooks">
          <div class="card h-100">
            <img src="/media/products/Notebook3.jpeg" class="card-img-top" alt="Bamboo Classic Notebook">
            <div class="card-body text-center">
              <h5 class="card-title">Bamboo Classic Notebook</h5>
              <form method="post" action="{% url 'products:add_to_cart' 13 %}">
                {% csrf_token %}
                <input type="hidden" name="quantity" value="1">
                <button type="submit" class="btn btn-dark">Add to Cart</button>
              </form>
            </div>
          </div>
        </div>

        <!-- T-shirts -->
        <!-- Grey T-shirt -->
<div class="col-12 mb-4 product-card" data-category="T-shirts">
  <div class="card flex-md-row h-100">
    <img src="/media/products/T-shirts1.jpeg" class="img-fluid" style="width: 200px; height: 200px; object-fit: cover;" alt="Grey T-shirt">
    <div class="card-body d-flex flex-column justify-content-center text-center">
      <h5 class="card-title">Grey T-shirt</h5>
      <form method="post" action="{% url 'products:add_to_cart' 14 %}">
        {% csrf_token %}
        <input type="hidden" name="quantity" value="1">
        <div class="form-group mb-2">
          <label for="size-14">Size</label>
          <select name="size" id="size-14" class="form-control" required>
            <option value="">Select Size</option>
            <option value="XS">XS</option>
            <option value="S">S</option>
            <option value="M">M</option>
            <option value="L">L</option>
            <option value="XL">XL</option>
            <option value="XXL">XXL</option>
            <option value="XXXL">XXXL</option>
          </select>
        </div>
        <button type="submit" class="btn btn-dark">Add to Cart</button>
      </form>
    </div>
  </div>
</div>

<!-- White T-shirt -->
<div class="col-12 mb-4 product-card" data-category="T-shirts">
  <div class="card flex-md-row h-100">
    <img src="/media/products/T-shirt2.jpeg" class="img-fluid" style="width: 200px; height: 200px; object-fit: cover;" alt="White T-shirt">
    <div class="card-body d-flex flex-column justify-content-center text-center">
      <h5 class="card-title">White T-shirt</h5>
      <form method="post" action="{% url 'products:add_to_cart' 11 %}">
        {% csrf_token %}
        <input type="hidden" name="quantity" value="1">
        <div class="form-group mb-2">
          <label for="size-11">Size</label>
          <select name="size" id="size-11" class="form-control" required>
            <option value="">Select Size</option>
            <option value="XS">XS</option>
            <option value="S">S</option>
            <option value="M">M</option>
            <option value="L">L</option>
            <option value="XL">XL</option>
            <option value="XXL">XXL</option>
            <option value="XXXL">XXXL</option>
          </select>
        </div>
        <button type="submit" class="btn btn-dark">Add to Cart</button>
      </form>
    </div>
  </div>
</div>

<!-- Black T-shirt -->
<div class="col-12 mb-4 product-card" data-category="T-shirts">
  <div class="card flex-md-row h-100">
    <img src="/media/products/T-shirt3.jpeg" class="img-fluid" style="width: 200px; height: 200px; object-fit: cover;" alt="Black T-shirt">
    <div class="card-body d-flex flex-column justify-content-center text-center">
      <h5 class="card-title">Black T-shirt</h5>
      <form method="post" action="{% url 'products:add_to_cart' 15 %}">
        {% csrf_token %}
        <input type="hidden" name="quantity" value="1">
        <div class="form-group mb-2">
          <label for="size-15">Size</label>
          <select name="size" id="size-15" class="form-control" required>
            <option value="">Select Size</option>
            <option value="XS">XS</option>
            <option value="S">S</option>
            <option value="M">M</option>
            <option value="L">L</option>
            <option value="XL">XL</option>
            <option value="XXL">XXL</option>
            <option value="XXXL">XXXL</option>
          </select>
        </div>
        <button type="submit" class="btn btn-dark">Add to Cart</button>
      </form>
    </div>
  </div>
</div>

      </div>
    </div>
  </div>
</div>
<style>
.card-img-top {
    height: 250px;
    object-fit: cover;
}
.card {
  display: flex;
  flex-direction: column;
}

.card-body {
  flex-grow: 1;
}
</style>
<script>
document.addEventListener("DOMContentLoaded", function () {
  const buttons = document.querySelectorAll(".filter-btn");
  const cards = document.querySelectorAll(".product-card");
  const forms = document.querySelectorAll("form[action^='/products/add-to-cart']");
  const toastEl = document.getElementById('category-toast');
  const toast = new bootstrap.Toast(toastEl);
  const cartItems = Array.from(document.querySelectorAll(".list-group-item")).map(li => {
    const text = li.textContent.trim();
    const category = Array.from(cards).find(card => {
      return card.querySelector(".card-title")?.textContent?.trim() && text.includes(card.querySelector(".card-title").textContent.trim());
    })?.getAttribute("data-category");
    return category ? { category } : null;
  }).filter(Boolean);

  const defaultCategory = "{{ selected_category }}";

  function filterByCategory(category) {
    cards.forEach(card => {
      const cardCategory = card.getAttribute("data-category");
      card.style.display = (category === "all" || cardCategory === category) ? "block" : "none";
    });

    buttons.forEach(btn => btn.classList.remove("active"));
    const activeBtn = document.querySelector(`.filter-btn[data-category="${category}"]`);
    if (activeBtn) activeBtn.classList.add("active");
  }

  function hasCategoryAlreadyInCart(category) {
    return cartItems.some(item => item.category === category);
  }

  forms.forEach(form => {
    form.addEventListener("submit", function (e) {
      const card = form.closest(".product-card");
      const category = card.getAttribute("data-category");

      if (hasCategoryAlreadyInCart(category)) {
        e.preventDefault();
        document.getElementById('toast-message').textContent = `You can only add one item from ${category}.`;
        toast.show();
      }
    });
  });

  buttons.forEach(button => {
    button.addEventListener("click", () => {
      const category = button.getAttribute("data-category");
      filterByCategory(category);
    });
  });

  const nextStepForm = document.getElementById("next-step-form");
  const nextCategoryInput = document.getElementById("next-category");

  nextStepForm.addEventListener("submit", function (e) {
    e.preventDefault();
    const currentCategory = "{{ selected_category }}";
    let nextCategory = "";

    if (currentCategory === "T-shirts") {
      nextCategory = "Notebooks";
    } else if (currentCategory === "Notebooks") {
      nextCategory = "Bottles";
    } else if (currentCategory === "Bottles") {
      window.location.href = "{% url 'products:magic_created' %}";
      return;
    }

    nextCategoryInput.value = nextCategory;
    nextStepForm.submit();
  });

  filterByCategory(defaultCategory);
});
</script>


{% endblock %}