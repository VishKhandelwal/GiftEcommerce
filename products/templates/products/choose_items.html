{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container">
  <h2>Choose Your Items</h2>

  <div class="row">
    <!-- Cart Summary -->
    <div class="col-md-4">
      <div class="card p-3">
        <h5>Your Cart</h5>
        <div id="cart-items">
          {% for item in cart_items %}
          <div class="d-flex justify-content-between align-items-center mb-2" data-item-id="{{ item.product.id }}">
            <div>
              <strong>{{ item.product.name }}</strong><br>
              ₹{{ item.product.price }} × {{ item.quantity }}
            </div>
            <div class="quantity-controls d-flex align-items-center gap-1" data-item-id="{{ item.product.id }}">
              <button class="btn btn-outline-secondary btn-sm btn-decrease">−</button>
              <span class="item-qty">{{ item.quantity }}</span>
              <button class="btn btn-outline-secondary btn-sm btn-increase">+</button>
            </div>
          </div>
          {% empty %}
          <p>No items in cart.</p>
          {% endfor %}
        </div>
        <hr>
        <p><strong>Subtotal:</strong> <span id="cart-subtotal">₹{{ subtotal }}</span></p>
        <a href="{% url 'products:magic_created' %}" class="btn btn-success">Next Step</a>
      </div>
    </div>

    <!-- Product Filters & Items -->
    <div class="col-md-8">
      <div id="category-buttons" class="mb-4">
        <button class="btn btn-outline-dark filter-btn" data-category="T-shirts">T-shirts</button>
        <button class="btn btn-outline-dark filter-btn" data-category="Notebooks">Notebooks</button>
        <button class="btn btn-outline-dark filter-btn" data-category="Water Bottles">Water Bottles</button>
      </div>

      <div id="products" class="row">
        {% csrf_token %}

        <!-- WATER BOTTLES -->
        {% for id, name, image, category in [
          (1, 'Clear Bottle', 'Bottle1.jpeg', 'Water Bottles'),
          (2, 'Bottle with Black Cap', 'Bottle2.jpeg', 'Water Bottles'),
          (3, 'Square Bottle', 'Bottle3.jpeg', 'Water Bottles'),
          (4, 'Slim Handle Bottle', 'Bottle4.jpeg', 'Water Bottles'),
          (5, 'Frosted Bottle', 'Bottle5.jpeg', 'Water Bottles'),
          (6, 'Minimalist Notebook', 'Notebook1.jpeg', 'Notebooks'),
          (7, 'Notebook2', 'Notebook2.jpeg', 'Notebooks'),
          (8, 'Notebook3', 'Notebook3.jpeg', 'Notebooks'),
          (9, 'Orange & White T-shirt', 'T-shirts1.jpeg', 'T-shirts'),
          (10, 'T-shirt', 'T-shirt2.jpeg', 'T-shirts'),
          (11, 'Black T-shirt', 'T-shirt3.jpeg', 'T-shirts')
        ] %}
        <div class="col-md-3 mb-4 product-card" data-category="{{ category }}">
          <div class="card h-100">
            <img src="/media/products/{{ image }}" class="card-img-top" alt="{{ name }}">
            <div class="card-body text-center">
              <h5 class="card-title">{{ name }}</h5>
              <form method="post" action="{% url 'products:add_to_cart' id %}" class="add-to-cart-form" data-category="{{ category }}">
                {% csrf_token %}
                <button type="submit" class="btn btn-dark">Add to Cart</button>
              </form>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<style>
.product-card {
  opacity: 0;
  transition: opacity 0.5s ease;
}
.product-card.show {
  opacity: 1;
}
.btn-secondary:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}
</style>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const selectedCategories = new Set();

    // Track selected categories based on cart
    document.querySelectorAll("#cart-items [data-item-id]").forEach(itemBlock => {
        const itemId = itemBlock.dataset.itemId;
        const form = document.querySelector(`form[action$='/${itemId}/']`);
        if (form) {
            const category = form.dataset.category;
            if (category) selectedCategories.add(category);
        }
    });

    // Disable buttons of already selected categories
    const cartForms = document.querySelectorAll(".add-to-cart-form");
    cartForms.forEach(form => {
        const category = form.dataset.category;
        if (selectedCategories.has(category)) {
            const btn = form.querySelector("button");
            btn.disabled = true;
            btn.classList.remove("btn-dark");
            btn.classList.add("btn-secondary");
        }
    });

    // Add to Cart restriction
    cartForms.forEach(form => {
        form.addEventListener("submit", function (e) {
            const category = form.dataset.category;
            if (selectedCategories.has(category)) {
                e.preventDefault();
                alert(`You can only add one item from the "${category}" category.`);
                return false;
            }

            selectedCategories.add(category);

            cartForms.forEach(otherForm => {
                if (otherForm !== form && otherForm.dataset.category === category) {
                    const btn = otherForm.querySelector("button");
                    btn.disabled = true;
                    btn.classList.remove("btn-dark");
                    btn.classList.add("btn-secondary");
                }
            });
        });
    });

    // Quantity update
    document.addEventListener("click", function (e) {
        if (e.target.classList.contains("btn-increase") || e.target.classList.contains("btn-decrease")) {
            const isIncrease = e.target.classList.contains("btn-increase");
            const container = e.target.closest(".quantity-controls");
            const itemId = container.dataset.itemId;
            const action = isIncrease ? "increase" : "decrease";

            updateQuantity(itemId, action);
        }
    });

    function updateQuantity(itemId, action) {
        fetch(`/products/update/${itemId}/${action}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const qtySpan = document.querySelector(`[data-item-id='${itemId}'] .item-qty`);
                if (qtySpan) qtySpan.textContent = data.quantity;

                const subtotalSpan = document.getElementById("cart-subtotal");
                if (subtotalSpan && data.subtotal !== undefined) {
                    subtotalSpan.textContent = `₹${data.subtotal}`;
                }

                if (data.quantity === 0) {
                    const itemBlock = document.querySelector(`#cart-items [data-item-id='${itemId}']`);
                    if (itemBlock) itemBlock.remove();

                    const category = data.category;
                    const forms = document.querySelectorAll(`.add-to-cart-form[data-category="${category}"]`);
                    forms.forEach(f => {
                        const btn = f.querySelector("button");
                        btn.disabled = false;
                        btn.classList.remove("btn-secondary");
                        btn.classList.add("btn-dark");
                    });

                    selectedCategories.delete(category);
                }
            }
        });
    }

    // Filtering
    const filterButtons = document.querySelectorAll(".filter-btn");
    const productCards = document.querySelectorAll(".product-card");

    function filterCategory(category) {
        productCards.forEach(card => {
            const cardCategory = card.getAttribute('data-category');
            if (category === "All" || category === cardCategory) {
                card.style.display = '';
                card.classList.add('show');
            } else {
                card.style.display = 'none';
                card.classList.remove('show');
            }
        });
    }

    filterButtons.forEach(btn => {
        btn.addEventListener("click", () => {
            const category = btn.dataset.category;
            filterButtons.forEach(b => b.classList.remove("active"));
            btn.classList.add("active");
            filterCategory(category);
        });
    });

    filterCategory("T-shirts"); // default view
});
</script>
{% endblock %}
